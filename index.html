<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street View ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ‡ãƒ¢ â€” YCAM</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #242836;
    --border: #2a2e3a;
    --text: #e8e9ed;
    --text-muted: #8b8fa3;
    --accent: #5b8af5;
    --accent-glow: rgba(91, 138, 245, 0.25);
    --pin-red: #ef4444;
    --pin-blue: #3b82f6;
    --pin-green: #22c55e;
    --pin-yellow: #eab308;
    --pin-purple: #a855f7;
    --radius: 10px;
    --font-ja: 'Noto Sans JP', sans-serif;
    --font-en: 'DM Sans', sans-serif;
  }

  body {
    font-family: var(--font-ja);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    z-index: 100;

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;

      .logo {
        width: 32px;
        height: 32px;
        background: var(--accent);
        border-radius: 8px;
        display: grid;
        place-items: center;
        font-family: var(--font-en);
        font-weight: 700;
        font-size: 14px;
        color: #fff;
      }

      h1 {
        font-size: 15px;
        font-weight: 700;
        letter-spacing: -0.02em;

        span {
          color: var(--text-muted);
          font-weight: 400;
          margin-left: 8px;
          font-size: 13px;
        }
      }
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;

      .badge {
        font-size: 11px;
        font-weight: 500;
        padding: 4px 10px;
        border-radius: 20px;
        background: var(--accent-glow);
        color: var(--accent);
        font-family: var(--font-en);
      }
    }
  }

  /* â”€â”€ Main layout â”€â”€ */
  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  /* â”€â”€ Street View container â”€â”€ */
  .streetview-wrap {
    flex: 1;
    position: relative;

    #streetview {
      width: 100%;
      height: 100%;
    }

    #markerOverlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 10;
    }
  }

  /* â”€â”€ Toolbar (floating) â”€â”€ */
  .toolbar {
    position: absolute;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px;
    background: rgba(26, 29, 39, 0.92);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    border-radius: 14px;
    z-index: 50;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);

    .tool-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      border-radius: var(--radius);
      background: transparent;
      color: var(--text-muted);
      font-family: var(--font-ja);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;

      &:hover {
        background: var(--surface-hover);
        color: var(--text);
      }

      &.active {
        background: var(--accent);
        color: #fff;
      }

      svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }
    }

    .divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 4px;
    }
  }

  /* â”€â”€ Sidebar â”€â”€ */
  .sidebar {
    width: 320px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;

      h2 {
        font-size: 14px;
        font-weight: 700;

        .count {
          color: var(--text-muted);
          font-weight: 400;
          margin-left: 6px;
        }
      }
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;

      &::-webkit-scrollbar {
        width: 4px;
      }
      &::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }
    }
  }

  /* â”€â”€ Annotation card â”€â”€ */
  .anno-card {
    padding: 12px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid transparent;

    &:hover {
      background: var(--surface-hover);
      border-color: var(--border);
    }

    &.selected {
      background: var(--surface-hover);
      border-color: var(--accent);
    }

    .anno-card-top {
      display: flex;
      align-items: flex-start;
      gap: 10px;

      .pin-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 4px;
      }

      .anno-info {
        flex: 1;
        min-width: 0;

        .anno-title {
          font-size: 13px;
          font-weight: 500;
          margin-bottom: 4px;
          line-height: 1.4;
        }

        .anno-meta {
          font-size: 11px;
          color: var(--text-muted);
          font-family: var(--font-en);
        }
      }
    }

    .anno-desc {
      margin-top: 8px;
      padding-left: 20px;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
    }
  }

  /* â”€â”€ Custom overlay marker in Street View â”€â”€ */
  .sv-marker {
    position: absolute;
    cursor: pointer;
    pointer-events: auto;
    transform: translate(-50%, -100%);
    transition: transform 0.15s ease;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
    z-index: 10;

    &:hover {
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.6));
      z-index: 20;
    }

    .marker-pin {
      width: 32px;
      height: 40px;
      position: relative;

      svg {
        width: 100%;
        height: 100%;
      }
    }

    .marker-label {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26, 29, 39, 0.92);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s, top 0.15s;
    }

    &:hover .marker-label {
      opacity: 1;
      top: -34px;
    }
  }

  /* â”€â”€ Modal for adding annotation â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: none;
    place-items: center;

    &.show {
      display: grid;
    }
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    width: 400px;
    max-width: 90vw;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);

    h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;

      label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 6px;
      }

      input, textarea {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-family: var(--font-ja);
        font-size: 13px;
        outline: none;
        transition: border-color 0.15s;

        &:focus {
          border-color: var(--accent);
        }
      }

      textarea {
        resize: vertical;
        min-height: 72px;
      }
    }

    .color-picker {
      display: flex;
      gap: 8px;

      .color-opt {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.15s;

        &.selected {
          border-color: #fff;
          transform: scale(1.15);
        }
      }
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 20px;

      button {
        padding: 8px 18px;
        border: none;
        border-radius: 8px;
        font-family: var(--font-ja);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }

      .btn-cancel {
        background: var(--bg);
        color: var(--text-muted);
        border: 1px solid var(--border);

        &:hover { color: var(--text); }
      }

      .btn-save {
        background: var(--accent);
        color: #fff;

        &:hover { background: #4a7ae4; }
      }
    }
  }

  /* â”€â”€ Drag pin (in toolbar) â”€â”€ */
  #dragPin {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px 4px 6px;
    border-radius: var(--radius);
    cursor: grab;
    user-select: none;
    transition: all 0.2s;
    position: relative;

    &:hover {
      background: var(--surface-hover);
      transform: translateY(-2px);

      .drag-pin-hint {
        color: var(--text);
      }
    }

    &:active {
      cursor: grabbing;
    }

    &.dragging {
      position: fixed;
      z-index: 1000;
      padding: 0;
      background: none;
      cursor: grabbing;
      transition: none;
      pointer-events: none;

      .drag-pin-hint { display: none; }

      .drag-pin-icon svg {
        width: 36px;
        height: 45px;
        filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5));
      }
    }

    &.invalid {
      filter: grayscale(1) opacity(0.4);
      cursor: not-allowed;
    }
  }

  .drag-pin-icon {
    display: flex;
    align-items: center;

    svg {
      width: 20px;
      height: 25px;
      filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
      transition: all 0.2s;
    }
  }

  .drag-pin-hint {
    font-size: 13px;
    color: var(--text-muted);
    pointer-events: none;
    white-space: nowrap;
    transition: color 0.15s;
  }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface);
    border: 1px solid var(--accent);
    color: var(--text);
    padding: 10px 20px;
    border-radius: var(--radius);
    font-size: 13px;
    z-index: 300;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;

    &.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">SV</div>
    <h1>Street View ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³<span>YCAMå‘¨è¾º</span></h1>
  </div>
  <div class="header-right">
    <div class="badge">DEMO</div>
  </div>
</div>

<!-- Main -->
<div class="main" id="mainArea">
  <!-- Street View -->
  <div class="streetview-wrap">
    <div id="streetview"></div>
    <div id="markerOverlay"></div>

    <!-- Floating Toolbar -->
    <div class="toolbar">
      <div id="dragPin">
        <div class="drag-pin-icon"><svg viewBox="0 0 32 40" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 0C7.163 0 0 7.163 0 16c0 12 16 24 16 24s16-12 16-24C32 7.163 24.837 0 16 0z" fill="#ef4444"/><circle cx="16" cy="14" r="6" fill="white" fill-opacity="0.9"/></svg></div>
        <div class="drag-pin-hint">ãƒ”ãƒ³ã‚’è¿½åŠ </div>
      </div>
      <div class="divider"></div>
      <button class="tool-btn" onclick="resetView()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        åˆæœŸä½ç½®ã«æˆ»ã‚‹
      </button>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³<span class="count" id="annoCount">(0)</span></h2>
    </div>
    <div class="sidebar-content" id="annoList"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>ğŸ“Œ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </h3>
    <div class="form-group">
      <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" id="annoTitle" placeholder="ä¾‹ï¼šYCAMã®å…¥å£">
    </div>
    <div class="form-group">
      <label>èª¬æ˜</label>
      <textarea id="annoDesc" placeholder="æ°—ã¥ã„ãŸã“ã¨ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
    </div>
    <div class="form-group">
      <label>ãƒ”ãƒ³ã®è‰²</label>
      <div class="color-picker" id="colorPicker">
        <div class="color-opt selected" data-color="#ef4444" style="background:#ef4444"></div>
        <div class="color-opt" data-color="#3b82f6" style="background:#3b82f6"></div>
        <div class="color-opt" data-color="#22c55e" style="background:#22c55e"></div>
        <div class="color-opt" data-color="#eab308" style="background:#eab308"></div>
        <div class="color-opt" data-color="#a855f7" style="background:#a855f7"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="saveAnnotation()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€
let panorama;
let isDragging = false;
let pendingClick = null;
let selectedColor = '#ef4444';
let annotations = [];
let overlays = [];
let selectedAnnoId = null;

// â”€â”€ Constants â”€â”€
const INITIAL_PANO_ID = 'Dq7hFTpha83NZqC1d4L1IA';
const EARTH_RADIUS = 6371000; // meters

// â”€â”€ Initial annotations (demo data) â”€â”€
// Each annotation is bound to a 3D world position (lat, lng, altitude-angle)
// heading/pitch are relative to the ORIGIN pano, and we store the
// world-space lat/lng so the pin can be projected from ANY nearby pano.
const demoAnnotations = [
  {
    id: 'demo1',
    panoId: INITIAL_PANO_ID,
    lat: 34.16945,
    lng: 131.46710,
    heading: 321.5,
    pitch: 2.0,
    title: 'YCAM ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹',
    desc: 'å±±å£æƒ…å ±èŠ¸è¡“ã‚»ãƒ³ã‚¿ãƒ¼ã®æ­£é¢å…¥å£ã€‚ã‚¬ãƒ©ã‚¹å¼µã‚Šã®ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ãŒç‰¹å¾´çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ã€‚',
    color: '#3b82f6',
    author: 'ç”°ä¸­å…ˆç”Ÿ',
    time: '2åˆ†å‰'
  },
  {
    id: 'demo2',
    panoId: INITIAL_PANO_ID,
    lat: 34.16895,
    lng: 131.46680,
    heading: 280.0,
    pitch: 5.0,
    title: 'é§è»Šå ´å…¥å£',
    desc: 'æ¥é¤¨è€…ç”¨ã®é§è»Šå ´ã¯ã“ã¡ã‚‰ã‹ã‚‰ã€‚',
    color: '#22c55e',
    author: 'ç”°ä¸­å…ˆç”Ÿ',
    time: '5åˆ†å‰'
  },
  {
    id: 'demo3',
    panoId: INITIAL_PANO_ID,
    lat: 34.16935,
    lng: 131.46725,
    heading: 350.0,
    pitch: -3.0,
    title: 'æ­©é“ã®ãƒ™ãƒ³ãƒ',
    desc: 'ä¼‘æ†©ã‚¹ãƒšãƒ¼ã‚¹ã€‚å¤©æ°—ã®è‰¯ã„æ—¥ã¯å¤–ã§ä¼‘ã‚€ã®ã«æœ€é©ã€‚',
    color: '#eab308',
    author: 'éˆ´æœ¨ã•ã‚“',
    time: '8åˆ†å‰'
  },
  {
    id: 'demo4',
    panoId: INITIAL_PANO_ID,
    lat: 34.16955,
    lng: 131.46740,
    heading: 10.0,
    pitch: 20.0,
    title: 'å±‹ä¸Šã®è¨­å‚™',
    desc: 'å»ºç‰©ä¸Šéƒ¨ã«è¨­ç½®ã•ã‚ŒãŸç©ºèª¿è¨­å‚™ã‚„é€šä¿¡ã‚¢ãƒ³ãƒ†ãƒŠãŒè¦‹ãˆã‚‹ã€‚',
    color: '#a855f7',
    author: 'ä½è—¤ã•ã‚“',
    time: '12åˆ†å‰'
  },
  {
    id: 'demo5',
    panoId: INITIAL_PANO_ID,
    lat: 34.16870,
    lng: 131.46690,
    heading: 240.0,
    pitch: 0.0,
    title: 'äº¤å·®ç‚¹æ–¹å‘',
    desc: 'YCAMã®å—è¥¿å´ã€‚ä¸­å¤®å…¬åœ’æ–¹é¢ã¸ã®é“è·¯ã€‚',
    color: '#ef4444',
    author: 'ç”°ä¸­å…ˆç”Ÿ',
    time: '15åˆ†å‰'
  }
];

// â”€â”€ Compute heading and pitch from one lat/lng to another â”€â”€
function computeBearing(fromLat, fromLng, toLat, toLng) {
  const DEG2RAD = Math.PI / 180;
  const RAD2DEG = 180 / Math.PI;

  const lat1 = fromLat * DEG2RAD;
  const lat2 = toLat * DEG2RAD;
  const dLng = (toLng - fromLng) * DEG2RAD;

  const y = Math.sin(dLng) * Math.cos(lat2);
  const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
  const bearing = Math.atan2(y, x) * RAD2DEG;

  return (bearing + 360) % 360;
}

function computeDistance(lat1, lng1, lat2, lng2) {
  const DEG2RAD = Math.PI / 180;
  const dLat = (lat2 - lat1) * DEG2RAD;
  const dLng = (lng2 - lng1) * DEG2RAD;
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * DEG2RAD) * Math.cos(lat2 * DEG2RAD) * Math.sin(dLng / 2) ** 2;
  return EARTH_RADIUS * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ç¾åœ¨ã®ãƒ‘ãƒãƒ©ãƒä½ç½®ã‹ã‚‰ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®lat/lngã¸ã®heading/pitchã‚’è¨ˆç®—ã™ã‚‹ã€‚
// pitchã¯è·é›¢ã®å¤‰åŒ–ã«å¿œã˜ã¦å†è¨ˆç®—ã•ã‚Œã‚‹ï¼ˆåŒã˜é«˜ã•ã®ç‚¹ã‚’æŒ‡ã—ç¶šã‘ã‚‹ãŸã‚ï¼‰ã€‚
//
// è¨ˆç®—æ–¹æ³•:
//   å…ƒã®è·é›¢ d0 ã¨è¨˜éŒ²æ™‚ã® pitch ã‹ã‚‰æ¨å®šé«˜ã• h = d0 * tan(pitch) ã‚’æ±‚ã‚ã€
//   ç¾åœ¨ã®è·é›¢ d1 ã‚’ä½¿ã£ã¦ pitch = atan2(h, d1) ã§å†è¨ˆç®—ã™ã‚‹ã€‚
//   d0 ã¨ d1 ã®æ¯”ç‡ã®ã¿ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€æŠ•å½±è·é›¢ãŒå¤§ãã„ã»ã©å®‰å®šã™ã‚‹ã€‚
function getAnnotationPov(anno, panoLat, panoLng) {
  const heading = computeBearing(panoLat, panoLng, anno.lat, anno.lng);

  // pitchå†è¨ˆç®—: è¨˜éŒ²æ™‚ã®è·é›¢ã¨pitchã‹ã‚‰æ¨å®šé«˜ã•ã‚’æ±‚ã‚ã€ç¾åœ¨ã®è·é›¢ã§è£œæ­£
  if (anno.originLat != null && anno.originLng != null) {
    const d0 = computeDistance(anno.originLat, anno.originLng, anno.lat, anno.lng);
    const d1 = computeDistance(panoLat, panoLng, anno.lat, anno.lng);
    if (d0 > 0.1) {
      const h = d0 * Math.tan(anno.pitch * Math.PI / 180);
      const pitch = Math.atan2(h, d1) * (180 / Math.PI);
      return { heading, pitch };
    }
  }

  return { heading, pitch: anno.pitch };
}

// â”€â”€ PanoMarker math (heading/pitch â†’ screen pixel) â”€â”€
function povToPixel(targetPov, currentPov, canvas) {
  const DEG2RAD = Math.PI / 180;

  // Zoom level â†’ FOV
  const zoom = panorama.getZoom() || 1;
  const fov = 180 / Math.pow(2, zoom);

  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;

  const hFov = fov * DEG2RAD;
  const vFov = 2 * Math.atan(Math.tan(hFov / 2) * (h / w));

  const dH = (w / 2) / Math.tan(hFov / 2);
  const dV = (h / 2) / Math.tan(vFov / 2);

  // Target and current in radians
  const tH = targetPov.heading * DEG2RAD;
  const tP = targetPov.pitch * DEG2RAD;
  const cH = currentPov.heading * DEG2RAD;
  const cP = currentPov.pitch * DEG2RAD;

  // 3D point on unit sphere for target
  const tx = Math.cos(tP) * Math.sin(tH - cH);
  const ty = Math.cos(tP) * Math.cos(tH - cH) * Math.sin(cP) - Math.sin(tP) * Math.cos(cP);
  const tz = Math.cos(tP) * Math.cos(tH - cH) * Math.cos(cP) + Math.sin(tP) * Math.sin(cP);

  // Behind camera
  if (tz < 0.01) return null;

  const px = (tx / tz) * dH + w / 2;
  const py = (ty / tz) * dV + h / 2;

  // Outside viewport
  if (px < -50 || px > w + 50 || py < -50 || py > h + 50) return null;

  return { x: px, y: py };
}

// â”€â”€ Pixel click â†’ heading/pitch â”€â”€
function pixelToPov(x, y, currentPov, canvas) {
  const DEG2RAD = Math.PI / 180;
  const RAD2DEG = 180 / Math.PI;

  const zoom = panorama.getZoom() || 1;
  const fov = 180 / Math.pow(2, zoom);

  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;

  const hFov = fov * DEG2RAD;
  const vFov = 2 * Math.atan(Math.tan(hFov / 2) * (h / w));

  const dH = (w / 2) / Math.tan(hFov / 2);

  const cH = currentPov.heading * DEG2RAD;
  const cP = currentPov.pitch * DEG2RAD;

  // Normalized screen coords
  const sx = x - w / 2;
  const sy = y - h / 2;

  // Direction vector in camera space
  const vx = sx;
  const vy = sy;
  const vz = dH;
  const len = Math.sqrt(vx * vx + vy * vy + vz * vz);

  // ã‚«ãƒ¡ãƒ©ç©ºé–“ã‹ã‚‰ãƒ¯ãƒ¼ãƒ«ãƒ‰ç©ºé–“ã¸ã®é€†å›è»¢
  const nx = vx / len;
  const ny = vy / len;
  const nz = vz / len;

  // Xè»¸å‘¨ã‚Šã« -pitch å›è»¢ï¼ˆã‚«ãƒ¡ãƒ©â†’ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤‰æ›ï¼‰
  // ç”»é¢Yã¯ä¸‹å‘ãã€ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®pitchæ­£ã¯ä¸Šå‘ããªã®ã§ã€å›è»¢ã‚’åè»¢ã•ã›ã‚‹
  const rx = nx;
  const ry = ny * Math.cos(cP) - nz * Math.sin(cP);
  const rz = ny * Math.sin(cP) + nz * Math.cos(cP);

  // World heading and pitch
  const heading = (Math.atan2(rx, rz) * RAD2DEG + currentPov.heading + 360) % 360;
  const pitch = Math.asin(Math.max(-1, Math.min(1, -ry))) * RAD2DEG;

  return { heading, pitch };
}

// â”€â”€ Create marker SVG â”€â”€
function markerSVG(color) {
  return `<svg viewBox="0 0 32 40" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M16 0C7.163 0 0 7.163 0 16c0 12 16 24 16 24s16-12 16-24C32 7.163 24.837 0 16 0z" fill="${color}"/>
    <circle cx="16" cy="14" r="6" fill="white" fill-opacity="0.9"/>
  </svg>`;
}

// â”€â”€ Render all overlays â”€â”€
function renderOverlays() {
  const container = document.getElementById('markerOverlay');
  const canvas = document.getElementById('streetview');
  const pov = panorama.getPov();
  const panoPos = panorama.getPosition();

  // Hide all first
  overlays.forEach(ov => ov.el.style.display = 'none');

  if (!panoPos) return;

  const panoLat = panoPos.lat();
  const panoLng = panoPos.lng();

  // è·é›¢ã«ã‚ˆã‚‹ãƒ”ãƒ³è¡¨ç¤ºåˆ¶å¾¡
  const MAX_DISTANCE = 80;   // ã“ã‚Œä»¥ä¸Šã¯éè¡¨ç¤º (m)
  const FADE_START = 50;      // ãƒ•ã‚§ãƒ¼ãƒ‰é–‹å§‹è·é›¢ (m)

  annotations.forEach((anno, i) => {
    const distance = computeDistance(panoLat, panoLng, anno.lat, anno.lng);

    if (distance > MAX_DISTANCE) {
      if (overlays[i]) overlays[i].el.style.display = 'none';
      return;
    }

    // Compute heading/pitch from current pano position to annotation world position
    const annoPov = getAnnotationPov(anno, panoLat, panoLng);
    const pos = povToPixel({ heading: annoPov.heading, pitch: annoPov.pitch }, pov, canvas);

    if (!overlays[i]) {
      const el = document.createElement('div');
      el.className = 'sv-marker';
      el.innerHTML = `
        <div class="marker-pin">${markerSVG(anno.color)}</div>
        <div class="marker-label">${anno.title}</div>
      `;
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        selectAnnotation(anno.id);
      });
      container.appendChild(el);
      overlays[i] = { el };
    }

    const el = overlays[i].el;
    el.querySelector('.marker-pin').innerHTML = markerSVG(anno.color);
    el.querySelector('.marker-label').textContent = anno.title;

    if (pos) {
      el.style.display = 'block';
      el.style.left = pos.x + 'px';
      el.style.top = pos.y + 'px';

      // è·é›¢ã«å¿œã˜ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã¨ãƒ•ã‚§ãƒ¼ãƒ‰ã‚’èª¿æ•´
      const scale = Math.max(0.4, 1 - (distance / MAX_DISTANCE) * 0.6);
      const opacity = distance > FADE_START
        ? 1 - (distance - FADE_START) / (MAX_DISTANCE - FADE_START)
        : 1;
      el.style.transform = `translate(-50%, -100%) scale(${scale})`;
      el.style.opacity = opacity;
    } else {
      el.style.display = 'none';
    }
  });
}

// â”€â”€ Render sidebar â”€â”€
function renderSidebar() {
  const list = document.getElementById('annoList');
  document.getElementById('annoCount').textContent = `(${annotations.length})`;

  list.innerHTML = annotations.map(a => `
    <div class="anno-card ${selectedAnnoId === a.id ? 'selected' : ''}" onclick="selectAnnotation('${a.id}')">
      <div class="anno-card-top">
        <div class="pin-dot" style="background:${a.color}"></div>
        <div class="anno-info">
          <div class="anno-title">${a.title}</div>
          <div class="anno-meta">${a.author} Â· ${a.time}</div>
        </div>
      </div>
      ${a.desc ? `<div class="anno-desc">${a.desc}</div>` : ''}
    </div>
  `).join('');
}

// â”€â”€ Select annotation â”€â”€
function selectAnnotation(id) {
  selectedAnnoId = id;
  const anno = annotations.find(a => a.id === id);
  if (anno) {
    const panoPos = panorama.getPosition();
    if (panoPos) {
      const pov = getAnnotationPov(anno, panoPos.lat(), panoPos.lng());
      panorama.setPov(pov);
    }
  }
  renderSidebar();
  renderOverlays();
}

// â”€â”€ Modal â”€â”€
function openModal() {
  document.getElementById('modalOverlay').classList.add('show');
  document.getElementById('annoTitle').focus();
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.getElementById('annoTitle').value = '';
  document.getElementById('annoDesc').value = '';
  pendingClick = null;
}

function saveAnnotation() {
  if (!pendingClick) return;

  const title = document.getElementById('annoTitle').value.trim() || 'ç„¡é¡Œã®ãƒ”ãƒ³';
  const desc = document.getElementById('annoDesc').value.trim();

  const panoPos = panorama.getPosition();
  const panoLat = panoPos.lat();
  const panoLng = panoPos.lng();

  // ã‚«ãƒ¡ãƒ©é«˜ã•ã¨pitchè§’åº¦ã‹ã‚‰ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã¾ã§ã®è·é›¢ã‚’æ¨å®šã™ã‚‹ã€‚
  //
  // pitch < 0ï¼ˆä¸‹å‘ã = åœ°é¢ï¼‰:
  //   è¦–ç·šã¨åœ°é¢ã®äº¤ç‚¹ã‚’ä½¿ã†ã€‚è·é›¢ = ã‚«ãƒ¡ãƒ©é«˜ã• / tan(|pitch|)
  //   å¹³å¦ãªåœ°é¢ã§ã¯æ­£ç¢ºãªå€¤ã«ãªã‚‹ã€‚
  //
  // pitch > 0ï¼ˆä¸Šå‘ã = å»ºç‰©ãƒ»é›»æŸ±ç­‰ï¼‰:
  //   ã‚«ãƒ¡ãƒ©ã‚ˆã‚Šç´„5mä¸Šã®é«˜ã•ã«ã‚ã‚‹ç‰©ä½“ã‚’æƒ³å®šã€‚è·é›¢ = 5 / tan(pitch)
  //   æ¨™è­˜ãƒ»é›»æŸ±ä¸­è…¹ãƒ»å»ºç‰©ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ãªã©ä¸€èˆ¬çš„ãªå¯¾è±¡ã«å¦¥å½“ãªè¿‘ä¼¼ã€‚
  //
  // pitch â‰ˆ 0ï¼ˆæ°´å¹³ = é æ–¹ï¼‰:
  //   tan(0)â†’0 ã§è·é›¢ãŒç™ºæ•£ã™ã‚‹ãŸã‚ã€ä¸Šé™100mã¨ã™ã‚‹ã€‚
  const DEG2RAD = Math.PI / 180;
  const CAMERA_HEIGHT = 2.5; // Street Viewã‚«ãƒ¡ãƒ©ã®åœ°é¢ã‹ã‚‰ã®é«˜ã• (m)
  const absPitch = Math.abs(pendingClick.pitch);
  let ESTIMATED_DISTANCE;
  if (absPitch < 1) {
    ESTIMATED_DISTANCE = 100; // ã»ã¼æ°´å¹³ â†’ é æ–¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  } else if (pendingClick.pitch < 0) {
    // è¦–ç·šã¨åœ°é¢ã®äº¤ç‚¹ã¾ã§ã®æ°´å¹³è·é›¢
    ESTIMATED_DISTANCE = Math.min(100, Math.max(5, CAMERA_HEIGHT / Math.tan(absPitch * DEG2RAD)));
  } else {
    const ABOVE_CAM_HEIGHT = 5; // ã‚«ãƒ¡ãƒ©ã‚ˆã‚Šä¸Šã®å¯¾è±¡ç‰©ã®æ¨å®šé«˜ã• (m)
    ESTIMATED_DISTANCE = Math.min(100, Math.max(5, ABOVE_CAM_HEIGHT / Math.tan(absPitch * DEG2RAD)));
  }
  const bearing = pendingClick.heading * DEG2RAD;
  const lat1 = panoLat * DEG2RAD;
  const lng1 = panoLng * DEG2RAD;
  const angularDist = ESTIMATED_DISTANCE / EARTH_RADIUS;

  const lat2 = Math.asin(
    Math.sin(lat1) * Math.cos(angularDist) +
    Math.cos(lat1) * Math.sin(angularDist) * Math.cos(bearing)
  );
  const lng2 = lng1 + Math.atan2(
    Math.sin(bearing) * Math.sin(angularDist) * Math.cos(lat1),
    Math.cos(angularDist) - Math.sin(lat1) * Math.sin(lat2)
  );

  const anno = {
    id: 'anno_' + Date.now(),
    panoId: panorama.getPano(),
    lat: lat2 / DEG2RAD,
    lng: lng2 / DEG2RAD,
    originLat: panoLat,
    originLng: panoLng,
    heading: pendingClick.heading,
    pitch: pendingClick.pitch,
    title,
    desc,
    color: selectedColor,
    author: 'ã‚ãªãŸ',
    time: 'ãŸã£ãŸä»Š'
  };

  annotations.push(anno);
  closeModal();
  renderSidebar();
  renderOverlays();
  showToast('ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

// â”€â”€ Toast â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ Color picker â”€â”€
document.getElementById('colorPicker').addEventListener('click', (e) => {
  const opt = e.target.closest('.color-opt');
  if (!opt) return;
  document.querySelectorAll('.color-opt').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  selectedColor = opt.dataset.color;
});

// â”€â”€ Reset view â”€â”€
function resetView() {
  panorama.setPov({ heading: 321.56, pitch: 0.13 });
  panorama.setZoom(1);
}

// â”€â”€ Drag pin â”€â”€
function initDragPin() {
  const dragPin = document.getElementById('dragPin');
  const toolbar = dragPin.parentElement;
  const svEl = document.getElementById('streetview');
  let isValid = false;

  function resetPin() {
    // body ã‹ã‚‰ toolbar ã«æˆ»ã™
    if (dragPin.parentElement !== toolbar) {
      toolbar.insertBefore(dragPin, toolbar.firstChild);
    }
    dragPin.style.left = '';
    dragPin.style.top = '';
    dragPin.style.transform = '';
    dragPin.classList.remove('dragging', 'invalid');
    isDragging = false;
    isValid = false;
  }

  dragPin.addEventListener('mousedown', (e) => {
    e.preventDefault();
    isDragging = true;
    dragPin.classList.add('dragging');

    // toolbar ã¯ backdrop-filter/transform ã‚’æŒã¤ãŸã‚ position: fixed ã®
    // åŸºæº–ãŒãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«ãªã‚‰ãªã„ã€‚body ã«ç§»å‹•ã—ã¦æ­£ã—ãå›ºå®šé…ç½®ã™ã‚‹ã€‚
    document.body.appendChild(dragPin);
    dragPin.style.left = e.clientX + 'px';
    dragPin.style.top = e.clientY + 'px';
    dragPin.style.transform = 'translate(-50%, -100%)';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    dragPin.style.left = e.clientX + 'px';
    dragPin.style.top = e.clientY + 'px';

    // SVã®ç¯„å›²å†…ã§ã®ã¿pitchåˆ¤å®š
    const svRect = svEl.getBoundingClientRect();
    const x = e.clientX - svRect.left;
    const y = e.clientY - svRect.top;

    if (x >= 0 && x <= svRect.width && y >= 0 && y <= svRect.height) {
      const pov = panorama.getPov();
      const targetPov = pixelToPov(x, y, pov, svEl);
      if (targetPov.pitch < -2) {
        isValid = true;
        dragPin.classList.remove('invalid');
      } else {
        isValid = false;
        dragPin.classList.add('invalid');
      }
    } else {
      isValid = false;
      dragPin.classList.add('invalid');
    }
  });

  document.addEventListener('mouseup', (e) => {
    if (!isDragging) return;

    if (isValid) {
      const svRect = svEl.getBoundingClientRect();
      const x = e.clientX - svRect.left;
      const y = e.clientY - svRect.top;
      const pov = panorama.getPov();
      const targetPov = pixelToPov(x, y, pov, svEl);
      pendingClick = targetPov;
      openModal();
    } else {
      showToast('åœ°é¢ã®ä¸Šã«ãƒ”ãƒ³ã‚’ç½®ã„ã¦ãã ã•ã„');
    }

    resetPin();
  });
}

// â”€â”€ Initialize Google Maps â”€â”€
function initMap() {
  panorama = new google.maps.StreetViewPanorama(
    document.getElementById('streetview'),
    {
      pano: 'Dq7hFTpha83NZqC1d4L1IA',
      pov: { heading: 321.56, pitch: 0.13 },
      zoom: 1,
      addressControl: false,
      showRoadLabels: false,
      motionTracking: false,
      motionTrackingControl: false
    }
  );

  // Load demo data
  annotations = [...demoAnnotations];
  renderSidebar();

  // Re-render overlays on POV / zoom / pano change
  panorama.addListener('pov_changed', renderOverlays);
  panorama.addListener('zoom_changed', renderOverlays);
  panorama.addListener('resize', renderOverlays);
  // ãƒãƒ¼ã‚«ãƒ¼ã¯ #markerOverlay å†…ã«ã‚ã‚Š Google Maps ã® DOM ç®¡ç†å¤–ã®ãŸã‚ã€
  // ãƒ‘ãƒãƒ©ãƒå¤‰æ›´æ™‚ã«ãƒãƒ¼ã‚«ãƒ¼ã®ç ´æ£„ãƒ»å†ç”Ÿæˆã¯ä¸è¦
  panorama.addListener('pano_changed', renderOverlays);
  panorama.addListener('position_changed', renderOverlays);

  // ãƒ‘ãƒãƒ©ãƒä½ç½®ãŒç¢ºå®šã—ãŸã‚‰ãƒ‡ãƒ¢ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã« originLat/originLng ã‚’è¨­å®š
  google.maps.event.addListenerOnce(panorama, 'pano_changed', () => {
    const initPos = panorama.getPosition();
    if (initPos) {
      annotations.forEach(a => {
        if (a.originLat == null) {
          a.originLat = initPos.lat();
          a.originLng = initPos.lng();
        }
      });
    }
    setTimeout(renderOverlays, 500);
  });

  initDragPin();
}

// Load the API
window.initMap = initMap;
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbT3YdIiNeYf7Jja0d2nttWy4rZhPoKKE&callback=initMap" async defer></script>

</body>
</html>
